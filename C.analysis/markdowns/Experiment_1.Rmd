---
title: "Experiment 1"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_notebook: 
    toc: true
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    theme: lumen
---
    
# Description 

In experiment 1 we apply the different FoRTE girdling treatments to the ED forest stand starting from a near bare ground run starting in 1900. 


### Set Up 

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
# The defaults for the chunks
knitr::opts_chunk$set(echo = TRUE, fig.width = 12, fig.height = 12)

library(ggplot2)
library(magrittr)
library(data.table)
library(cowplot)
library(lubridate)
library(purrr)
library(fortedata)

BASE_DIR <- here::here()
THEME    <- theme_bw(base_size = 30)

ALPHA <- 0.05
BCK_GRND1 <- '#dcffcc'
BCK_GRND2 <- '#9fdfcd'
BCK_GRND3 <- '#baabda'
DISTURBANCE_COLORS <- c("0" = "#000000", "45" = "#009E73", "65" = "#0072B2", "85" = "#D55E00")

MONTHLY_BACKGROUND <- function(plot){
  plot + 
    geom_rect(aes(xmin=ymd('1900-01-01'), xmax = ymd('1979-12-01'),
                  ymin = -Inf, ymax = Inf), fill = BCK_GRND1, alpha = ALPHA) +
    geom_rect(aes(xmin=ymd('1980-01-01'), xmax = ymd('2015-12-01'),
                  ymin = -Inf, ymax = Inf), fill = BCK_GRND2, alpha = ALPHA) +
    geom_rect(aes(xmin=ymd('2016-01-01'), xmax = ymd('2029-01-01'),
                  ymin = -Inf, ymax = Inf), fill = BCK_GRND3, alpha = ALPHA) + 
    labs(caption = 'colored background: looped over 1979 - 1978, obs. 1979 - 2016, avg 2008 - 2018') 
}
ANNUAL_BACKGROUND <- function(plot){
  plot + 
    geom_rect(aes(xmin=1900, xmax = 1979,
                  ymin = -Inf, ymax = Inf), fill = BCK_GRND1, alpha = ALPHA) +
    geom_rect(aes(xmin=1979, xmax = 2015,
                  ymin = -Inf, ymax = Inf), fill = BCK_GRND2, alpha = ALPHA) +
    geom_rect(aes(xmin=2015, xmax = 2029,
                  ymin = -Inf, ymax = Inf), fill = BCK_GRND3, alpha = ALPHA) + 
    labs(caption = 'colored background: looped over 1979 - 1978, obs. 1979 - 2016, avg 2008 - 2018')
}
ADD_BACKGROUND <- function(plot){
  
  if(any(c('date', 'datetime') %in% names(plot$data))){
    p <- MONTHLY_BACKGROUND(plot)
  } else if ('year' %in% names(plot$data)){
    p <- ANNUAL_BACKGROUND(plot)
  }
  return(p)
}

ADD_DISTURBANCE_LINE_MONTH  <- geom_vline(xintercept = date('2019-05-01'), color = 'grey', size = 2)
ADD_DISTURBANCE_LINE_ANNUAL <- geom_vline(xintercept = 2019, color = 'grey', size = 2)
ADD_COLORS <- scale_color_manual(values = DISTURBANCE_COLORS) 
```

Import the results 

```{r}
# Note that this is the object created with the drake frame work, 
# there should be some better way to trigger this.
exp_object <- readRDS(file.path(BASE_DIR, 'ED-outputs', "exp-1.rds"))
exp_object <- map(exp_object, function(x){ x[year < 2030, ] }) 

# Update the data for with the disturbance severity
add_disturbance_severity <- function(list){
  y <- map(list, function(x){
    x[data.table(scn = c("harvest 0", "harvest 45", "harvest 65", "harvest 85"), 
                 `disturbance severity` = c("0", "45", "65", "85")), on = 'scn'] 
  })
  return(y)
}

exp_object <- add_disturbance_severity(exp_object)
```

Event information 

```
<year> 2019 </year>
<doy> 141 </doy>
```

# Meteorological Inputs 

> 
* dlwrf — downward long wave radiation (W m-2)
* nbdsf — near infrared beam downward solar radiation (W m-2)
* nddsf — near IR diffuse downward solar radiation (W m-2)
* vbdsf — visible beam downward solar radiation (W m-2)
* vddsf — visible diffuse downward solar radiation (W m-2)
* prate — precipitation rate (kgH2O m-2 s-1)
* pres — atmospheric pressure (Pa)
* hgt — geopotential height (m)
* ugrd — zonal wind (m s-1)
* vgrd — meridional wind (m s-1)
* sh — specific humidity (kgH2O kgAir-1)
* tmp — air temperature (K)

```{r, fig.width = 12, fig.height = 6}
met_data <- as.data.table(read.csv(file.path(BASE_DIR, 'A.inputs', 'monthly_mean_met.csv')))
met_data$date <- ymd(paste(met_data$year, met_data$month, '01', sep = '/'))

long_met_data <- melt(met_data, measure.vars = c("nbdsf", "nddsf", "vbdsf", "vddsf",
                                                 "prate", "dlwrf", "pres", "hgt", "ugrd", 
                                                 "vgrd", "sh", "tmp"),
                      variable.name = 'variable', value.name = 'value')
long_met_data <- as.data.table(long_met_data[, c("date", "variable", "value", "year")])

var_info <- data.table(variable = c('dlwrf', 'nbdsf', 'nddsf', 'vbdsf',
                                    'vddsf', 'prate', 'pres', 'hgt', 
                                    'ugrd', 'vgrd', 'sh', 'tmp'), 
                       description = c('downward long wave radiation', 
                                       'near infrared beam downward solar radiation', 
                                       'near IR diffuse downward solar radiation', 
                                       'visible beam downward solar radiation',
                                       'visible diffuse downward solar radiation', 
                                       'precipitation rate', 
                                       'atmospheric pressure', 
                                       'geopotential height', 
                                       'zonal wind',
                                       'meridional wind', 
                                       'specific humidity',
                                       'air temperature'),  
                       units = c('W m-2', 'W m-2', 'W m-2', 'W m-2',
                                 'W m-2', 'kgH2O m-2 s-1', 'Pa', 'm',
                                 'm s-1', 'm s-', 'kgH2O kgAir-1', 'K'))
long_met_data <- long_met_data[var_info, on = 'variable']
long_met_data <- long_met_data[variable != 'hgt', ] # exclude the geo spatial height on cause it doesn't 
```


```{r}
ADD_BACKGROUND(plot = ggplot(data = long_met_data)) +
  geom_line(aes(date, value)) + 
  facet_wrap("variable", scales = 'free') + 
  labs(title = 'Monthly Time Series of ED Met Data Inputs', y = NULL) + 
  THEME
```

Because of the variability in the seasonal cycle is rather large and hides longer trem trends. Let's take a look at the annual min, max and mean. 

```{r}
annual_data <- long_met_data[ , list('value' = mean(value), 'min' = min(value), 'max' = max(value)),
                              by = list(year, variable)]

ADD_BACKGROUND(plot = ggplot(data = annual_data)) +
  geom_ribbon(aes(year, ymin = min, ymax = max), fill = 'grey') + 
  geom_line(aes(year, min), color = 'grey') + 
  geom_line(aes(year, max), color = 'grey') + 
  geom_line(aes(year, value)) +
  facet_wrap('variable', scales = 'free') + 
  labs(y = NULL) 
```

Zooming in what does the actual observational data look like? 

```{r}
ggplot(data = annual_data[year %in% 1979:2008, ]) +
  geom_ribbon(aes(year, ymin = min, ymax = max), fill = 'grey') + 
  geom_line(aes(year, min), color = 'grey') + 
  geom_line(aes(year, max), color = 'grey') + 
  geom_line(aes(year, value)) +
  facet_wrap('variable', scales = 'free') + 
  THEME + 
  labs(y = NULL)
```


# Baseline Scenario


```{r, fig.width = 12, fig.height = 6}
# Process the data to plot, the annual values. 
exp_object$NPP[scn == 'harvest 0', ] %>%  
    .[  , value := sum(value), by = c('year', 'variable', 'unit', 'scn')] %>% 
    .[ , list(year, variable, unit, scn, value)] %>% 
  unique() -> 
  NPP_to_plot

exp_object$LAI[scn == 'harvest 0', ] %>%
  .[  , value := sum(value), by = c('datetime', 'variable', 'unit', 'scn')] %>% 
  .[ , list(datetime, variable, unit, scn, value)] %>%  
  unique() -> 
  LAI_to_plot

exp_object$NEP[scn == 'harvest 0', ] %>%  
  .[  , value := sum(value), by = c('year', 'variable', 'unit', 'scn')] %>% 
  .[ , list(year, variable, unit, scn, value)] %>%  
  unique() -> 
  NEP_to_plot

exp_object$ABG[scn == 'harvest 0', ] %>%  
  .[  , value := sum(value), by = c('year', 'variable', 'unit', 'scn')] %>% 
  .[ , list(year, variable, unit, scn, value)] %>%  
  unique() -> 
  ABG_to_plot

exp_object$GPP[scn == "harvest 0", ] %>%  
  .[  , value := sum(value), by = c('year', 'variable', 'unit', 'scn')] %>% 
  .[ , list(year, variable, unit, scn, value)] %>%  
  unique() -> 
  GPP_to_plot


ADD_BACKGROUND(plot = ggplot(data = NPP_to_plot)) + 
  geom_line(aes(year, value), size = 1) +
  THEME +
  labs(title ='NPP',
       x = 'Year', 
       y = unique(exp_object$NPP[scn == 'harvest 0', ][['unit']]), caption = NULL) -> 
  NPP_plot

ADD_BACKGROUND(plot = ggplot(data = LAI_to_plot)) + 
  geom_point(aes(datetime, value)) + 
  THEME + 
  labs(title ='LAI',
       x = 'Year', 
       y = unique(exp_object$LAI[scn == 'harvest 0', ][['unit']]), caption = NULL, size = 0.01) -> 
  LAI_plot

ADD_BACKGROUND(ggplot(NEP_to_plot)) + 
  geom_line(aes(year, value), size = 1) +
  THEME + 
  labs(title ='NEP',
       x = 'Year', 
       y = unique(exp_object$NEP[scn == 'harvest 0', ][['unit']]), caption = NULL) -> 
  NEP_plot

ADD_BACKGROUND(ggplot(ABG_to_plot)) + 
  geom_line(aes(year, value), size = 1) + 
  THEME + 
  labs(title ='ABG',
       x = 'Year', 
       y = unique(exp_object$ABG[scn == 'harvest 0', ][['unit']]), caption = NULL) -> 
  ABG_plot

ADD_BACKGROUND(ggplot(GPP_to_plot)) + 
  geom_point(aes(year, value), size = 1) + 
  THEME + 
  labs(title = 'GPP', 
       x = 'Year', 
       y = 'kg/m2/yr') -> 
  GPP_plot

plot_grid(ABG_plot, NPP_plot, NEP_plot, LAI_plot, GPP_plot)
```

One potential idea would be to use an ensemble of climate data to create a an envelope of runs. 



# Experiment 1 

## Above Ground Biomass

```{r, fig.width = 12, fig.height = 6}
exp_object$ABG$datetime <- date(exp_object$ABG$datetime)
data <- exp_object$ABG[  , value := sum(value), 
                         by = c("datetime", "scn", "unit", "year", "disturbance severity")] 
ggplot(data = data) + 
  ADD_DISTURBANCE_LINE_MONTH + 
  geom_line(aes(datetime, value, color = `disturbance severity`, 
                group = interaction(scn, pft_name)),
            size = 1.5) + 
  THEME + 
  ADD_COLORS + 
  labs(x = 'Year', y = unique(exp_object$ABG$unit), title = 'ABG') 
```


## NPP 

Annual values, what is odd is that the harvest 0% has NPP is more negative than the other treatments? Is that because of reading in the 0 harvest? Also does the monthly NPP have any other patterns?  


```{r,  fig.width = 12, fig.height = 6}
ggplot(exp_object$NPP[year %in% 2000:2030, ]) +
  ADD_DISTURBANCE_LINE_ANNUAL +
  geom_line(aes(year, value, color = `disturbance severity`, 
                group = interaction(scn, pft_name)), size = 1.5) + 
  THEME + 
  coord_cartesian(xlim = c(2000, 2025)) + 
  labs(x = 'Year', y = unique(exp_object$NPP$unit), title = 'Annual NPP') + 
  ADD_COLORS
```

So the annual is some what hard to see the the pattern with it but after a decade there the NPP has not returned to the annual values. 

```{r}
h0_object  <- readRDS(file.path(BASE_DIR, 'ED-outputs', 'exp-1', 'harvest_0_above.rds'))
h45_object <- readRDS(file.path(BASE_DIR, 'ED-outputs', 'exp-1', 'harvest_45_above.rds'))
h65_object <- readRDS(file.path(BASE_DIR, 'ED-outputs', 'exp-1', 'harvest_65_above.rds'))
h85_object <- readRDS(file.path(BASE_DIR, 'ED-outputs', 'exp-1', 'harvest_85_above.rds'))

h0 <- as.data.table(h0_object$df_cohort[[1]])[  ,list(datetime, MMEAN_NPP_CO, PFT, DBH, NPLANT)]
h45 <- as.data.table(h45_object$df_cohort[[1]])[  ,list(datetime, MMEAN_NPP_CO, PFT, DBH, NPLANT)]
h65 <- as.data.table(h65_object$df_cohort[[1]])[  ,list(datetime, MMEAN_NPP_CO, PFT, DBH, NPLANT)]
h85 <- as.data.table(h85_object$df_cohort[[1]])[  ,list(datetime, MMEAN_NPP_CO, PFT, DBH, NPLANT)]

h0$severity  <- '0'
h45$severity <- '45'
h65$severity <- '65'
h85$severity <- '85'

NPP <- rbind(h0, h45, h65, h85)
# Convert the NPP units from per plant to unit area
NPP$value <- NPP$MMEAN_NPP_CO * NPP$NPLANT
NPP$unit  <- unique(exp_object$NPP$unit)
NPP <- NPP[, c("datetime", "PFT", "severity", "value", 'unit')]
NPP$year <- lubridate::year(NPP$datetime)
NPP$datetime <- date(NPP$datetime)
monthly_NPP <- NPP
```


```{r}
NPP_monthly <- monthly_NPP[, value := sum(value), by = c("datetime", "severity", "unit", "year")]
NPP_monthly$value <- NPP_monthly$value / 12

ggplot(NPP_monthly) + 
  ADD_DISTURBANCE_LINE_MONTH + 
  geom_line(aes(datetime, value, color = severity)) + 
  THEME + 
  ADD_COLORS +
  labs(title = 'NPP', y = 'kgC/m2/month', x = 'Time') 
```


```{r}
NPP_monthly %>% 
  .[year %in% 2018:2022] %>%  
  ggplot(aes(datetime, value, color = severity)) + 
  ADD_DISTURBANCE_LINE_MONTH +
  ADD_COLORS +
  geom_line(size = 1.5) + 
  THEME + 
  labs(title = 'Monthly NPP', y = 'kgC/m2/month', x = 'Time') 
```


## NEP 

```{r}
exp_object$NEP %>% 
  dplyr::filter(year >= 2000 & year <= 2021) %>% 
  ggplot() + 
  geom_vline(xintercept = 2019, color = 'grey', size = 1.5) + 
  geom_line(aes(year, value, color = `disturbance severity`), size = 1.5) + 
  THEME + 
  ADD_COLORS +
  labs(x = 'Year', y = unique(exp_object$NEP$unit), title = 'Annual NEP')
```

```{r}
h0 <- as.data.table(h0_object$df_scalar[[1]])[ ,list(datetime, MMEAN_NEP_PY)]
h45 <- as.data.table(h45_object$df_scalar[[1]])[ ,list(datetime, MMEAN_NEP_PY)]
h65 <- as.data.table(h65_object$df_scalar[[1]])[ ,list(datetime, MMEAN_NEP_PY)]
h85 <- as.data.table(h85_object$df_scalar[[1]])[ ,list(datetime, MMEAN_NEP_PY)]

h0$severity  <- '0'
h45$severity <- '45'
h65$severity <- '65'
h85$severity <- '85'

NEP <- rbind(h0, h45, h65, h85)
NEP$unit  <- unique(exp_object$NEP$unit)
NEP <- NEP[, c("datetime", "severity", "value" = "MMEAN_NEP_PY")]
names(NEP) <- c("datetime", "severity", "value")
NEP$year <- lubridate::year(NEP$datetime)
NEP$datetime <- date(NEP$datetime)
```


```{r}
NEP %>% 
  dplyr::filter(year >= 2019 & year <= 2021) %>% 
  dplyr::mutate(value = value / 12, 
                units = 'kg/m2/month') %>% 
  ggplot() + 
  ADD_DISTURBANCE_LINE_MONTH + 
  geom_line(aes(datetime, value, color = severity), size = 1) + 
  THEME + 
  ADD_COLORS +
  labs(x = 'Year', y ='kg/m2/month', title = 'Monthly NEP')
```


## LAI

```{r}
exp_object$LAI$year <- year(exp_object$LAI$datetime)
exp_object$LAI %>% 
  dplyr::filter(year >= 2018 & year <= 2025) %>% 
  ggplot() + 
  ADD_DISTURBANCE_LINE_MONTH + 
  geom_line(aes(datetime, value, color = `disturbance severity`)) + 
  ADD_COLORS +
  THEME + 
  labs(x = 'Year', y = unique(exp_object$LAI$unit), title = 'Monthly LAI') + 
  facet_wrap('pft_name', ncol = 1)
```

## Soil Respiration 

```{r}
h0 <- as.data.table(h0_object$df_scalar[[1]])[  ,list(datetime, MMEAN_RH_PY)]
h45 <- as.data.table(h45_object$df_scalar[[1]])[  ,list(datetime, MMEAN_RH_PY)]
h65 <- as.data.table(h65_object$df_scalar[[1]])[  ,list(datetime, MMEAN_RH_PY)]
h85 <- as.data.table(h85_object$df_scalar[[1]])[  ,list(datetime, MMEAN_RH_PY)]

h0$severity  <- '0'
h45$severity <- '45'
h65$severity <- '65'
h85$severity <- '85'

RH    <- rbind(h0, h45, h65, h85)
units <- 'kg/m2/yr'

RH %>% 
ggplot(aes(datetime, MMEAN_RH_PY, color = severity)) + 
  geom_line() + 
  THEME + 
  labs(title = 'Monthly Heterotrophic Respiration', 
       y = units,
       x = 'Date Time') + 
  ADD_COLORS
```

```{r}
RH[datetime >= ymd('2018-06-01') & datetime <= ymd('2021-01-01'), ] %>% 
ggplot(aes(datetime, MMEAN_RH_PY, color = severity)) + 
  geom_line(size = 1.5) + 
  THEME + 
  labs(title = 'Monthly Heterotrophic Respiration', 
       y = units,
       x = 'Date Time') + 
  ADD_COLORS
```


## GPP 

```{r}
GPP <- exp_object$GPP
GPP$severity <- GPP$`disturbance severity`

GPP %>% 
    .[  , value := mean(value), by = c('year', 'variable', 'unit', 'scn', 
                                      'PFT', 'description', 'severity', 
                                      'pft_name')] %>% 
    .[ , list(year, variable, scn, value, unit, pft_name,
              PFT, description, severity)] -> 
  GPP_to_plot

GPP_to_plot %>%    
  ggplot(aes(year, value, color = severity)) + 
  geom_point(size = 3) + 
  ADD_COLORS + 
  THEME + 
  labs(title = 'Annual GPP per Treatment', 
       y = 'kgC/m2/yr')
```

```{r}
GPP <- exp_object$GPP
GPP$severity <- GPP[['disturbance severity']]
GPP$datetime <- date(GPP$datetime)
GPP$PFT <- as.character(GPP$PFT)

# Add the cohort labels to the data
split(GPP, interaction(GPP$datetime, GPP$severity, GPP$PFT)) %>% 
  lapply(function(x){
    
    x$cohort <- LETTERS[1:nrow(x)]
    return(x)
    
  }) %>%  
  rlist::list.rbind() -> 
  GPP_cohort


to_plot <- GPP_cohort[year %in% 2018:2020, ] 
to_plot$value <- to_plot$value / 12
to_plot %>%  
  ggplot(aes(datetime, value, group = interaction(cohort, severity), color = severity)) + 
  geom_line(size = 2) + 
  facet_grid(. ~ pft_name) + 
  THEME + 
  ADD_COLORS + 
  labs(title = 'Cohort GPP', 
       y = 'kgC/m2/month', 
       x = 'Date')
```


## Carbon Cycling Resistance

Carbon Cycling Resistance

$$r = \ln \left( {\frac{{F_{{\text{dist}}} }}{{F_{{\text{cont}}} }}} \right)$$ Equation 1 from Gough 2020. 

```{r}

exp_object$NPP[year %in% 2018:2030, ] %>%  
  .[, list(pft_name, year, variable, unit, value, severity = `disturbance severity`)] %>% 
  # Make the table wide by disturbance severity treatment. 
  dcast(data = ., pft_name + year + variable + unit ~ severity) %>%
  # Now gather all of the distubrance treatments into a single column so that the 
  # control values are recorded in their own column. 
  melt(data = ., id.vars = c("pft_name", "year", "variable", "unit", "0"), 
       measure.vars = c('45', '65', '85'), variable.name = 'severity', 
       value.name = 'treatment_value') %>%  
  # Rename the columns 
  .[ , list(pft_name, year, variable, unit, control = `0`, severity, dist = treatment_value)] %>% 
  # Now calculate r 
  .[ , r := log(dist/control)] -> 
  NPP_r
  
NPP_r %>%   
ggplot(aes(year, r, color = severity)) + 
  geom_line(size = 1.5) + 
  ADD_COLORS + 
  THEME + 
  labs(title = 'NPP Resistance Values', 
       y = expression('r'[npp]), 
       x = 'Year')
```


<br>

**** 

```{r}
sessionInfo()
```
